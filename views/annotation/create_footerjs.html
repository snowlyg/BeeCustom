<script>
    layui.config({
        base: '/static/customAdmin/'
    }).extend({
        index: 'lib/index'
    }).use(['index', 'form', 'admin', 'table', 'layuicomplete', 'laydate', 'laytpl'], async () => {
        const {form, admin, table, $, laytpl, layuicomplete} = layui;
        const cusIEFlag = 'I';
        let order_i_edit_data;
        let order_pros_data_filter = [],
            order_id  /**订单ID**/
            , order_note_data /**附注数据**/
            , annotation_searc_index;  /**商品快速查询index**/

        /**根据屏幕等比例缩小**/
        admin.sideFlexible_window();

        /**回车键光标跳转**/
        admin.keydown_input_textarea();

        /**首次进入自动聚焦 and 初始数据赋值**/
        const first_name = $("#invt_type_name").val();

        $("#invt_type_name").val("").focus().val(first_name);
        $("#input_time").val(admin.getCurrDate());
        $("#invt_dcl_time").val(admin.getCurrDate());

        /**清单产品/报关草稿列表**/
        admin.getAnnotationTable(admin.order_pros_data, admin.decListData);

        /**光标进入全选**/
        $('body').on('focus', 'input,textarea', function (e) {
            $(this).select();
            let tipText = "";
            for (let item of admin.tipsJson) {
                if (item.id === this.id) {
                    tipText = item.name;
                    break;
                }
            }
            $("#tipsMessagetext").text(tipText);
        });

        /**table点击行选中**/
        admin.table_radio_click();
        /**table左右拖动**/
        admin.table_mousedown();

        /**备注回车保存商品**/
        $("body").on("keyup", "#body_rmk", function (event) {
            const eCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
            if (event.shiftKey !== 1 && eCode === 13) {
                $("#order_pros_submit").click();
            }
        });

        /**保存商品**/
        let order_pros_index = null;
        const annotation_item_data = (data) => {
            /**集报不允许新增**/
            if (($("#invt_type").val() === "1" || $("#invt_type").val() === "8") && data.gds_seqno > admin
                .order_pros_data.length) {
                layer.open({
                    title: "提示",
                    content: "当前清单类型不允许新增！",
                    icon: 2
                });
                return;
            }
            let _row = {};
            $.extend(_row, admin.order_pros_data[order_pros_index - 1]);
            if (_row && _row.gds_seqno && _row.gds_seqno !== data.gds_seqno) {
                layer.open({
                    title: "提示",
                    content: "表体序号不能修改！",
                    icon: 2
                });
                return;
            }
            /**如果报关则生成报关商品**/
            if ($("#dclcus_flag").val() === "1") {

                /**如果用户设置报关单序号，检查序号是否合规**/
                if (admin.DecListGNoCheck(data, admin.decListData, admin.order_pros_data) === false) return;
                if (!data.entry_gds_seqno) {
                    data.entry_gds_seqno = data.gds_seqno
                }
            }

            if (admin.DecListCountCheck(data, admin.decListData) === false) {
                layer.open({
                    title: "提示",
                    content: "本保税清单对应的报关单表体已经50条(不可超过50条)，请确认后重新录入！",
                    icon: 2
                });
                return;
            }

            /**
             * foreach data array
             *
             * add item+'_string'
             *
             * **/
            for (let item in data) {
                if ($.inArray(item, admin.annotaion_items_arr) >= 0) {
                    data[item + '_string'] = data[item]
                }
            }

            /** edit **/
            if (order_pros_index) {
                for (let item in data) {
                    admin.order_pros_data[order_pros_index - 1][item] = data[item]
                }
            } else {
                /** create **/
                admin.order_pros_data.push(data);
            }

            admin.order_pros_data.forEach((value, index) => {
                value.gds_seqno = index + 1
            });

            /**如果报关则生成报关商品**/
            admin.decListData = admin.InitInvtList2DecList(admin.decListData, admin.order_pros_data);
            table.reload('customs_declaration_list', {
                data: admin.decListData,
                limit: admin.decListData.length
            });

            table.reload('order_pros', {
                data: admin.order_pros_data,
                limit: admin.order_pros_data.length
            });
        };
        form.on('submit(order_pros_submit)', function (form) {
            if (admin.order_pros_data.length > 1) {
                if (form.field.dcl_currcd !== admin.order_pros_data[0].dcl_currcd) {
                    return layer.msg("币制不一致！");
                }
            }
            if (form.field.gdecd.toString().length !== 10) {
                return layer.msg("商品编号必须为10位！");
            }
            let data = form.field;
            annotation_item_data(data);
            order_pros_index = null;
            $("#order_pros_form input").each(function () {
                if ($(this).attr("id") === "gds_seqno") {
                    $(this).val(admin.order_pros_data.length + 1)
                } else {
                    if (!($(this).is("[no_empty]"))) {
                        $(this).val("")
                    }
                }
            });
            $("#putrec_seqno").focus();
        });
        /**商品--点击行反填数据**/
        table.on('row(order_pros)', function (obj) {
            for (let item in obj.data) {
                if ($.inArray(item, admin.annotaion_items_arr) >= 0) {
                    $(`#${item}`).val(obj.data[item + '_string'])
                } else if (item === 'rmk') {
                    $(`#${'body_' + item}`).val(obj.data[item])
                } else {
                    $(`#${item}`).val(obj.data[item])
                }
            }
            order_pros_index = obj.data.gds_seqno;
        });
        /**商品列表--按钮操作**/
        table.on('toolbar(order_pros)', async function (obj) {
            let checkStatus = table.checkStatus(obj.config.id);
            let checkData = checkStatus.data;
            switch (obj.event) {
                case 'add':
                    order_pros_index = null;
                    $("#order_pros_form input").each(function () {
                        if ($(this).attr("id") === "gds_seqno") {
                            $(this).val(admin.order_pros_data.length + 1)
                        } else {
                            if (!($(this).is("[no_empty]"))) {
                                $(this).val("")
                            }
                        }
                    });
                    $("#putrec_seqno").focus();
                    break;
                case 'delete':
                    if (checkData.length === 0) {
                        return layer.msg('请选择数据');
                    }
                    layer.confirm('真的删除么', {
                        title: '提示'
                    }, async (index) => {
                        let sup_data = admin.order_pros_data.filter(item => {
                            return checkData.every(item2 => {
                                return item.gds_seqno !== item2.gds_seqno;
                            })
                        });
                        if (checkData[0].id) {
                            admin.annotation_items_delete_ids.push(checkData[0].id);
                        }
                        admin.order_pros_data = sup_data;
                        admin.order_pros_data.forEach((value, index) => {
                            value.gds_seqno = index + 1
                        });

                        /**如果报关则生成报关商品**/
                        admin.decListData = admin.InitInvtList2DecList(admin
                            .decListData, admin.order_pros_data);
                        table.reload('customs_declaration_list', {
                            data: admin.decListData,
                            limit: admin.decListData.length
                        });

                        table.reload('order_pros', {
                            data: admin.order_pros_data,
                            limit: admin.order_pros_data.length
                        });
                        order_pros_index = null;
                        $("#order_pros_form input").each(function () {
                            if ($(this).attr("id") === "gds_seqno") {
                                $(this).val(admin.order_pros_data.length + 1)
                            } else {
                                if (!($(this).is("[no_empty]"))) {
                                    $(this).val("")
                                }
                            }
                        });
                        $("#putrec_seqno").focus();
                        layer.close(index);
                    });
                    break;
                case 'copy':
                    if (checkData.length === 0) {
                        return layer.msg('请选择数据');
                    }
                    if (checkData.length != 1) {
                        return layer.msg('只能选择一条数据复制');
                    }
                    if (admin.DecListCountCheck(checkData[0], admin.decListData) === false) {
                        layer.open({
                            title: "提示",
                            content: "本保税清单对应的报关单表体已经50条(不可超过50条)，请确认后重新录入！",
                            icon: 2
                        });
                        return;
                    }
                    checkData[0].gds_seqno = admin.order_pros_data.length + 1;
                    if (checkData[0].id) {
                        delete checkData[0].id
                    }
                    admin.order_pros_data.push(checkData[0]);

                    /**如果报关则生成报关商品**/
                    admin.decListData = admin.InitInvtList2DecList(admin.decListData, admin
                        .order_pros_data);
                    table.reload('customs_declaration_list', {
                        data: admin.decListData,
                        limit: admin.decListData.length
                    });

                    table.reload('order_pros', {
                        data: admin.order_pros_data,
                        limit: admin.order_pros_data.length
                    });
                    $(`.layui-table-view[lay-id='order_pros'] .layui-table-body tr[data-index=${admin.order_pros_data.length - 1}]`)
                        .click();
                    break;
                case 'search':
                    if (cusIEFlag === 'I') {
                        if (admin.ann_materials_data.length === 0) {
                            return layer.msg('手(账)册编号不能为空');
                        }
                    } else {
                        if (admin.ann_goods_data.length === 0) {
                            return layer.msg('手(账)册编号不能为空');
                        }
                    }
                    annotation_searc_index = layer.open({
                        type: 1,
                        title: '商品快速查询',
                        shadeClose: true,
                        area: admin.screen() < 2 ? ['80%', '300px'] : ['950px', '540px'],
                        content: $('#annotation_search_template').html()
                    });
                    $("#gds_mtno_filter").focus();
                    table.render({
                        elem: '#annotation_search_table',
                        defaultToolbar: ['filter'],
                        colFilterRecord: 'local',
                        cols: [
                            [{
                                type: 'radio'
                            }, {
                                field: 'serial',
                                title: '备案序号',
                                width: 100
                            }, {
                                field: 'record_no',
                                title: '商品料号',
                                width: 140
                            }, {
                                field: 'hs_code',
                                title: '商品编码',
                                width: 140
                            }, {
                                field: 'name',
                                title: '商品名称',
                                width: 240
                            }, {
                                field: 'special',
                                title: '规格型号',
                                width: 240
                            }, {
                                field: 'unit_one',
                                title: '申报计量单位',
                                width: 130
                            }, {
                                field: 'unit_two',
                                title: '法定计量单位',
                                width: 130
                            }, {
                                field: 'unit_three',
                                title: '法定第二计量单位',
                                width: 160
                            }, {
                                field: 'fst_sf_val',
                                title: '第一比例因子',
                                width: 140
                            }, {
                                field: 'secd_sf_val',
                                title: '第二比例因子',
                                width: 140
                            }]
                        ],
                        data: order_pros_data_filter,
                        limit: order_pros_data_filter.length,
                        height: 370
                    });
                    break;
            }
        });

        /**商品快速查询--查询**/
        form.on('submit(order_search_filter)', (data) => {
            let search_not = 0;
            for (let item in data.field) {
                if (data.field[item].trim()) {
                    search_not = 1
                }
            }
            if (!search_not) {
                return layer.msg('查询条件不能为空');
            }

            let data_search = get_ann_goods_materials_data(cusIEFlag);
            const condition = {
                record_no: data.field.gds_mtno_filter,
                hs_code: data.field.gdecd_filter,
                name: data.field.gds_nm_filter
            };
            const data_filter = (condition, data) => {
                return data.filter(item => {
                    return Object.keys(condition).every(key => {
                        return String(item[key]).toLowerCase().includes(
                            String(condition[key]).trim().toLowerCase())
                    })
                })
            };
            order_pros_data_filter = data_filter(condition, data_search);
            table.reload('annotation_search_table', {
                data: order_pros_data_filter,
                limit: order_pros_data_filter.length
            });
        });

        /**商品快速查询--保存反填**/
        $("body").on("click", "#annotation_search_save", function () {
            const checkData = table.checkStatus("annotation_search_table").data;
            if (checkData.length === 0) {
                return layer.msg('请选择')
            }
            $("#putrec_seqno").val(checkData[0].serial);
            $("#gds_mtno").val(checkData[0].record_no);
            $("#gdecd").val(checkData[0].hs_code);
            $("#gds_nm").val(checkData[0].name);
            $("#gds_spcf_model_desc").val(checkData[0].special);

            $("#dcl_unitcd").val(checkData[0].unit_one_code);
            $("#dcl_unitcd_name").val(checkData[0].unit_one);

            $("#dcl_uprc_amt").val(checkData[0].price);

            $("#lawf_unitcd").val(checkData[0].unit_two_code);
            $("#lawf_unitcd_name").val(checkData[0].unit_two);

            $("#natcd").val(checkData[0].manuplace_code);
            $("#natcd_name").val(checkData[0].manuplace);

            $("#entry_gds_seqno").focus();
            layer.close(annotation_searc_index);
        });

        /**新建进口报关保存刷新后反填数据**/
        async function order_i_edit_back_filling(order_i_edit_data) {
            $("#order_i_form input, #order_i_form textarea").each(function () {
                for (let item in order_i_edit_data) {
                    if ($(this).attr("id") == item) {
                        if (item == 'input_time' || item == 'invt_dcl_time') {
                            const time = admin.getyyyymmdd(order_i_edit_data[item]);
                            $(this).val(time);
                        } else {
                            $(this).val(order_i_edit_data[item])
                        }
                    }
                }
            });
            if (order_i_edit_data.promise_itmes) {
                $(`input[name='promise_itmes[]']`).each(function (index, element) {
                    for (let item in order_i_edit_data.promise_itmes) {
                        if (index == item) {
                            $(this).next('div').click();
                        }
                    }
                });
            }
            if (!(order_i_edit_data.type)) {
                $(`input[name='type[]']`).each(function (index, element) {
                    if (index == 1) {
                        $(this).next('div').click();
                    }
                });
            }
            await order_i_add_back_filling(order_i_edit_data);
        }

        /**新建保税清单（进口）保存反填数据**/
        async function order_i_add_back_filling(order_i_edit_data) {
            if (parent.layui.admin.get_iframe_index()) {
                parent.layui.admin.get_iframe_index().find("span").append(order_i_edit_data
                    .etps_inner_invt_no);
                if (order_i_edit_data.status_string !== '已完成') {
                    const lay_id = parent.layui.admin.get_iframe_index().attr("lay-id").replace("/create",
                        "");
                    parent.layui.admin.get_iframe_index().attr("lay-id",
                        `${lay_id}/${order_id}/#/id=${order_id}`);
                    parent.layui.admin.get_iframe_index().attr("lay-attr",
                        `${lay_id}/${order_id}/#/id=${order_id}`);
                }
            }
            if (order_i_edit_data.items.length > 0) {
                admin.order_pros_data = order_i_edit_data.items;
                $("#gds_seqno").val(order_i_edit_data.items.length + 1);
                /**如果报关则生成报关商品**/
                admin.decListData = admin.InitInvtList2DecList(admin.decListData, admin.order_pros_data);
                table.reload('customs_declaration_list', {
                    data: admin.decListData,
                    limit: admin.decListData.length
                });
                table.reload('order_pros', {
                    data: admin.order_pros_data,
                    limit: admin.order_pros_data.length
                });
            }
            order_note_data = order_i_edit_data.extra_remark;
            if (order_note_data) {
                $("#order_note_dot").show()
            } else {
                $("#order_note_dot").hide()
            }
            $("#order_dispatch").data("user", order_i_edit_data.company.user_id);
            admin.annotation_items_delete_ids = [];
        };
        /**进口清单保存**/
        $("body").on("click", "#order_save", function () {
            $("#annotation_save").click();
        });
        form.on('submit(annotation_save)', async (data) => {
            layer.load(2);
            /**表体商品数据**/
            for (let item of admin.annotation_items_delete_ids) {
                admin.order_pros_data.push({
                    id: item
                })
            }
            data.field.items = admin.order_pros_data;
            if (!order_id) {
                const order_save_data = await admin.post("/", data
                    .field);
                if (order_save_data.status) {
                    order_id = order_save_data.data.id;
                    const url = document.URL;
                    history.pushState(null, null, `${url}/${order_id}`);
                    await order_i_add_back_filling(order_save_data.data);
                    order_i_edit_data = order_save_data.data;
                }
            } else {
                data.field.id = order_id;
                data.field.status = order_i_edit_data.status_string;
                const order_save_data = await admin.post("/", data
                    .field);
                if (order_save_data.status) {
                    await order_i_add_back_filling(order_save_data.data);
                    order_i_edit_data = order_save_data.data;
                }
            }
            layer.closeAll('loading');
        });
        /**派单**/
        let distribute_index;
        $("body").on("click", "#order_dispatch", async function () {
            if (!order_id) {
                return layer.msg("请先保存订单！")
            }
            distribute_index = layer.open({
                type: 1,
                title: '派单',
                shadeClose: true,
                area: admin.screen() < 2 ? ['80%', '300px'] : ['650px', '340px'],
                content: $('#distribute_template').html()
            });
            const user_id = $(this).data("user");
            $("select[name='user_id']").find(`option[value=${user_id}]`).prop("selected", true);
            form.render();
        });
        $("body").on("input", "#remark_distribute", function () {
            $("#remark_distribute_number span").text($(this).val().length);
        });
        /**派单保存**/
        form.on('submit(distribute_submit)', async (data) => {
            await admin.post(`/annotation/i/${order_id}/distribute`, data.field);
            layer.close(distribute_index);
        });
        /**附注**/
        let order_note_index;
        $("body").on("click", "#order_note", async function () {
            if (!order_id) {
                return layer.msg("请先保存订单！")
            }
            order_note_index = layer.open({
                type: 1,
                title: '附注',
                shadeClose: true,
                area: admin.screen() < 2 ? ['80%', '300px'] : ['650px', '340px'],
                content: $('#remark_note_template').html()
            });
            form.render();
            if (order_note_data) {
                $("#remark_note").val(order_note_data)
            }
            $("#order_note_dot").hide();
        });
        $("body").on("input", "#remark_note", function () {
            $("#remark_note_number span").text($(this).val().length);
        });
        /**附注保存**/
        form.on('submit(remark_note_submit)', async (data) => {
            order_note_data = data.field.extra_remark;
            await admin.post(`/annotation/i/${order_id}/extra_remark`, data.field);
            layer.close(order_note_index);
        });
        /**新建保存后刷新提取数据**/
        if ($("#order_i_edit_data").val()) {
            layer.load(2);
            order_i_edit_data = JSON.parse($("#order_i_edit_data").val())

            order_id = order_i_edit_data.id;
            laytpl($("#order_button_template").html()).render(order_i_edit_data.status_string, function (html) {
                $("#order_button").html(html)
            });
            laytpl($("#order_edit_bill_template").html()).render(order_i_edit_data, function (html) {
                $("#order_edit_bill").html(html)
            });
            await order_i_edit_back_filling(order_i_edit_data);
            const data = await admin.get(
                `/annotation/two_account_manual?limit=0&search=${$("#putrec_no").val()}`);
            if (data.length === 0) {
                layer.msg(`手(账)册编号：${$("#putrec_no").val()} 不存在！`, {
                    offset: '15px',
                    icon: 2,
                    time: 1000,
                    id: 'Message'
                });
            } else {
                if (cusIEFlag == 'I') {
                    admin.ann_materials_data = data[0].materials.data
                } else {
                    admin.ann_goods_data = data[0].goods.data
                }
            }
            layer.closeAll('loading');
        } else {
            laytpl($("#order_button_template").html()).render('新建', function (html) {
                $("#order_button").html(html)
            });
        }

        /**审核通过**/
        $("body").on("click", "#order_save_pass", function () {
            $("#annotation_save_pass").click();
        });
        form.on('submit(annotation_save_pass)', async (data) => {
            layer.load(2);
            /**表体商品数据**/
            for (let item of admin.annotation_items_delete_ids) {
                admin.order_pros_data.push({
                    id: item
                })
            }
            data.field.items = admin.order_pros_data;
            data.field.status = '审核通过';
            if (!order_id) {
                const order_save_data = await admin.post("/", data
                    .field);
                if (order_save_data.status) {
                    order_id = order_save_data.data.id;
                    const url = document.URL;
                    history.pushState(null, null, `${url}/${order_id}`);
                    await order_i_add_back_filling(order_save_data.data);
                    order_i_edit_data = order_save_data.data;
                }
            } else {
                if (order_i_edit_data.status_string === '审核通过' || order_i_edit_data.status_string === '待派单') {
                    layer.closeAll('loading');
                    return layer.msg('该订单已经通过审核');
                }
                await admin.get(`/annotation/i/${order_id}/audit_pass`, 'show');
            }
            layer.closeAll('loading');
        });
        /**办理记录**/
        $("body").on("click", "#order_take", async function () {
            if (!order_id) {
                return layer.msg("请先保存订单！")
            }
            layer.load(2);
            const data_order = await admin.get(`/annotation/i/${order_id}/annotation_logs`);
            layer.closeAll('loading');
            const data = {
                data_order: data_order
            };
            laytpl($("#order_take_template").html()).render(data, function (html) {
                $("#order_take_list").html(html)
            });
            layer.open({
                type: 1,
                title: '办理记录',
                shadeClose: true,
                area: admin.screen() < 2 ? ['80%', '300px'] : ['600px', '500px'],
                content: `<div id="order_take_list_content">${$('#order_take_list').html()}</div>`
            });
        });
        /**打印**/
        $("body").on("click", "#order_print", async function () {
            if (!order_id) {
                return layer.msg("请先保存订单！")
            }
            window.open(`/annotation/i/${order_id}/downloads/prints?margin_top=1cm&margin_left=0cm&margin_right=0cm&margin_bottom=1cm`);
        });
        /**表单验证规则**/
        form.verify({});


        /**保税清单（进口）自动完成汇总**/
        $("body").on("click", "#order_rebase", async function () {
            try {
                layer.load(2);
                for (let item in admin.annotations_complete_data) {

                    admin.annotations_complete_data[item] = [];
                    layui.data(item, null);
                }

                layer.closeAll('loading');
            } catch (err) {
                console.log(err)
            }
        });


        await admin.annotations_auto(layuicomplete);
    });
</script>