<script>
    layui.config({
        base: '/static/customAdmin/'
    }).extend({
        index: 'lib/index'
    })
        .use(['index', 'form', 'admin', 'table', 'layuicomplete', 'laydate', 'laytpl'], async () => {
            const {form, admin, table, $, laytpl, layuicomplete} = layui;
            let order_pros_data_filter = [],
                order_id  /**订单ID**/
                , order_note_data /**附注数据**/
                , annotationItems /**清单表体数据**/
                , decListData = [] /**默认报关单数据**/
                , AnnotationSearcIndex;
            /**商品快速查询index**/

            await admin.annotations_auto(layuicomplete);

            //禁用表体 tab 点击
            if (!@{{.m.Id}}) {
                let $annotationItemTab = $("#annotation_item_tab");
                $annotationItemTab.click(function (event) {
                    return false;
                });
            }

            /**根据屏幕等比例缩小**/
            admin.sideFlexible_window();
            /**回车键光标跳转**/
            admin.keydown_input_textarea();

            /**首次进入自动聚焦 and 初始数据赋值**/
            const first_name = $("#InvtTypeName").val();
            $("#InvtTypeName").val("").focus().val(first_name);
            $("#InputTime").val(admin.getCurrDate());
            $("#InvtDclTime").val(admin.getCurrDate());

            /**清单产品/报关草稿列表**/
            annotationItems = await admin.post("/annotation_item/datagrid", JSON.stringify({
                AnnotationId: parseInt(
                    @{{.m.Id}})
            }), true);

            admin.getAnnotationTable(annotationItems, []);

            /**光标进入全选**/
            $('body').on('focus', 'input,textarea', function (e) {
                $(this).select();
                let tipText = "";
                for (let item of admin.tipsJson) {
                    if (item.id === this.id) {
                        tipText = item.name;
                        break;
                    }
                }
                $("#tipsMessagetext").text(tipText);
            });

            /**table点击行选中**/
            admin.table_radio_click();
            /**table左右拖动**/
            admin.table_mousedown();

            /**备注回车保存商品**/
            $("body").on("keyup", "#BodyRmk", function (event) {
                const eCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
                if (event.shiftKey !== 1 && eCode === 13) {
                    $("#order_pros_submit").click();
                }
            });

            /**保存商品**/
            const annotation_item_data = async (data) => {
                /**集报不允许新增**/
                if (($("#InvtType").val() === "1" || $("#InvtType").val() === "8")
                    && data.GdsSeqno > annotationItems.length) {
                    layer.open({
                        title: "提示",
                        content: "当前清单类型不允许新增！",
                        icon: 2
                    });
                    return;
                }

                // let _row = {};
                // $.extend(_row, annotationItems[order_pros_index - 1]);
                // if (_row && _row.GdsSeqno && _row.GdsSeqno !== data.GdsSeqno) {
                //     layer.open({
                //         title: "提示",
                //         content: "表体序号不能修改！",
                //         icon: 2
                //     });
                //     return;
                // }

                /*保存表体*/
                let result;
                if (data.Id) {
                    data.AnnotationId = "@{{.m.Id}}"
                    result = await admin.patch("/annotation_item/update/" + data.Id, data);
                } else {
                    result = await admin.post("/annotation_item/store/" + @{{.m.Id}}, data);
                }

                if (result.status === 1) {
                    await transformAnnotationItemsTable(result.obj.Annotation.Id, data)
                }

            };

            form.on('submit(order_pros_submit)', function (form) {
                if (annotationItems.rows.length > 1) {
                    if (form.field.DclCurrcd !== annotationItems.rows[0].DclCurrcd) {
                        return layer.msg("币制不一致！");
                    }
                }

                if (form.field.Gdecd.toString().length !== 10) {
                    return layer.msg("商品编号必须为10位！");
                }

                annotation_item_data(form.field);/*加载表体数据*/
            });

            /**商品--点击行反填数据**/
            table.on('row(order_pros)', function (obj) {
                for (let item in obj.data) {
                    if (item === 'Rmk') {
                        $(`#${'Body' + item}`).val(obj.data[item])
                    } else if (item === 'Id') {
                        $(`#${'AnnotationItem' + item}`).val(obj.data[item])
                    } else {
                        $(`#${item}`).val(obj.data[item])
                    }
                }
            });

            /**商品列表--按钮操作**/
            table.on('toolbar(order_pros)', async function (obj) {
                let checkStatus = table.checkStatus(obj.config.id);
                let checkData = checkStatus.data;
                switch (obj.event) {
                    case 'add':
                        order_pros_form_focus();
                        break;
                    case 'delete':

                        if (checkData.length === 0) {
                            return layer.msg('请选择数据');
                        }

                        layer.confirm('真的删除么', {
                            title: '提示'
                        }, async (index) => {
                            if (checkData[0].Id) {
                                let result = await admin.delete("/annotation_item/delete/" + checkData[0].Id)
                                if (result.status === 1) {
                                    await transformAnnotationItemsTable(@{{.m.Id}}, "")
                                }
                            }
                            layer.close(index);
                        });
                        break;
                    case 'copy':

                        if (checkData.length === 0) {
                            return layer.msg('请选择数据');
                        }

                        if (checkData.length !== 1) {
                            return layer.msg('只能选择一条数据复制');
                        }

                        if (admin.DecListCountCheck(checkData[0], admin.decListData) === false) {
                            layer.open({
                                title: "提示",
                                content: "本保税清单对应的报关单表体已经50条(不可超过50条)，请确认后重新录入！",
                                icon: 2
                            });
                            return;
                        }

                        checkData[0].GdsSeqno = annotationItems.total + 1;
                        if (checkData[0].Id) {
                            delete checkData[0].Id
                        }

                        await annotation_item_data(checkData[0]);

                        $(`.layui-table-view[lay-id='order_pros'] .layui-table-body tr[data-index=${annotationItems.total - 1}]`).click();

                        break;
                    case 'search':
                        if (cusIEFlag === 'I') {
                            if (admin.ann_materials_data.length === 0) {
                                return layer.msg('手(账)册编号不能为空');
                            }
                        } else {
                            if (admin.ann_goods_data.length === 0) {
                                return layer.msg('手(账)册编号不能为空');
                            }
                        }

                        AnnotationSearcIndex = layer.open({
                            type: 1,
                            title: '商品快速查询',
                            shadeClose: true,
                            area: admin.screen() < 2 ? ['80%', '300px'] : ['950px', '540px'],
                            content: $('#annotation_search_template').html()
                        });
                        $("#gds_mtno_filter").focus();

                        table.render({
                            elem: '#annotation_search_table',
                            defaultToolbar: ['filter'],
                            colFilterRecord: 'local',
                            cols: [
                                [{
                                    type: 'radio'
                                }, {
                                    field: 'Serial',
                                    title: '备案序号',
                                    width: 100
                                }, {
                                    field: 'RecordNo',
                                    title: '商品料号',
                                    width: 140
                                }, {
                                    field: 'HsCode',
                                    title: '商品编码',
                                    width: 140
                                }, {
                                    field: 'Name',
                                    title: '商品名称',
                                    width: 240
                                }, {
                                    field: 'Special',
                                    title: '规格型号',
                                    width: 240
                                }, {
                                    field: 'UnitOne',
                                    title: '申报计量单位',
                                    width: 130
                                }, {
                                    field: 'UnitTwo',
                                    title: '法定计量单位',
                                    width: 130
                                }, {
                                    field: 'UnitThree',
                                    title: '法定第二计量单位',
                                    width: 160
                                }, {
                                    field: 'FstSfVal',
                                    title: '第一比例因子',
                                    width: 140
                                }, {
                                    field: 'SecdSfVal',
                                    title: '第二比例因子',
                                    width: 140
                                }]
                            ],
                            data: order_pros_data_filter,
                            limit: order_pros_data_filter.length,
                            height: 370
                        });
                        break;
                }
            });

            /**商品快速查询--查询**/
            form.on('submit(order_search_filter)', (data) => {
                let search_not = 0;
                for (let item in data.field) {
                    if (data.field[item].trim()) {
                        search_not = 1
                    }
                }
                if (!search_not) {
                    return layer.msg('查询条件不能为空');
                }

                let data_search = get_ann_goods_materials_data(cusIEFlag);
                const condition = {
                    RecordNo: data.field.gds_mtno_filter,
                    HsCode: data.field.gdecd_filter,
                    Name: data.field.gds_nm_filter
                };
                const data_filter = (condition, data) => {
                    return data.filter(item => {
                        return Object.keys(condition).every(key => {
                            return String(item[key]).toLowerCase().includes(
                                String(condition[key]).trim().toLowerCase())
                        })
                    })
                };
                order_pros_data_filter = data_filter(condition, data_search);
                table.reload('annotation_search_table', {
                    data: order_pros_data_filter,
                    limit: order_pros_data_filter.length
                });
            });

            /**商品快速查询--保存反填**/
            $("body").on("click", "#annotation_search_save", function () {
                const checkData = table.checkStatus("annotation_search_table").data;
                if (checkData.length === 0) {
                    return layer.msg('请选择')
                }
                $("#PutrecSeqno").val(checkData[0].Serial);
                $("#GdsMtno").val(checkData[0].RecordNo);
                $("#Gdecd").val(checkData[0].HsCode);
                $("#GdsNm").val(checkData[0].Name);
                $("#GdsSpcfModelDesc").val(checkData[0].Special);

                $("#DclUnitcd").val(checkData[0].UnitOneCode);
                $("#DclUnitcdName").val(checkData[0].UnitOne);

                $("#DclUprcAmt").val(checkData[0].Price);

                $("#LawfUnitcd").val(checkData[0].UnitTwoCode);
                $("#LawfUnitcdName").val(checkData[0].UnitTwo);

                $("#Natcd").val(checkData[0].ManuplaceCode);
                $("#NatcdName").val(checkData[0].Manuplace);

                $("#EntryGdsSeqno").focus();

                layer.close(AnnotationSearcIndex);
            });


            /**进口清单保存**/
            $("body").on("click", "#order_save", function () {
                $("#annotation_save").click();
            });

            form.on('submit(annotation_save)', async (data) => {
                layer.load(2);
                /**表体商品数据**/
                data.field.ImpexpMarkcd = "@{{.ImpexpMarkcd}}";
                if (@{{ .m.Id }}) {
                    const annotation_data = await admin.patch("/annotation/update/" + @{{ .m.Id }}, data.field);
                    if (annotation_data.status === 1) {
                        setTimeout(() => {
                            window.location.reload()
                        }, 300);

                    }
                } else {
                    const annotation_data = await admin.post("/annotation/store/" + @{{ .ImpexpMarkcd }}, data.field);
                    if (annotation_data.status === 1) {
                        setTimeout(() => {
                            window.location.href = "/annotation/edit/" + annotation_data.obj.Id
                        }, 300);

                    }
                }

                layer.closeAll('loading');
            });


            /**派单**/
            admin.distribute("#order_dispatch", @{{.m.Id}});

            /**附注**/
            let order_note_index;
            $("body").on("click", "#order_note", async function () {
                if (!order_id) {
                    return layer.msg("请先保存订单！")
                }

                order_note_index = layer.open({
                    type: 1,
                    title: '附注',
                    shadeClose: true,
                    area: admin.screen() < 2 ? ['80%', '300px'] : ['650px', '340px'],
                    content: $('#remark_note_template').html()
                });

                form.render();

                if (order_note_data) {
                    $("#remark_note").val(order_note_data)
                }
                $("#order_note_dot").hide();
            });

            $("body").on("input", "#remark_note", function () {
                $("#remark_note_number span").text($(this).val().length);
            });

            /**附注保存**/
            form.on('submit(remark_note_submit)', async (data) => {
                order_note_data = data.field.ExtraRemark;
                await admin.post(`/annotation/i/${order_id}/extra_remark`, data.field);
                layer.close(order_note_index);
            });

            /**审核通过**/
            $("body").on("click", "#order_save_pass", function () {
                $("#annotation_save_pass").click();
            });

            form.on('submit(annotation_save_pass)', async () => {
                layer.load(2);

                let result = await admin.get(`/annotation/audit/` + @{{.m.Id}}, 'show');
                if (result.status === 1) {
                    window.location.reload();
                    admin.reloadFrame('进口核注清单iframe');
                }

                layer.closeAll('loading');
            });

            /**办理记录**/
            $("body").on("click", "#order_take", async function () {
                if (!@{{.m.Id}}) {
                    return layer.msg("请先保存订单！")
                }

                layer.load(2);
                const annotationRecords = await admin.post(`/annotation_record/datagrid`,JSON.stringify({AnnotationId:parseInt(@{{.m.Id}})}),true);
                layer.closeAll('loading');

                laytpl($("#order_take_template").html()).render(annotationRecords.rows, function (html) {
                    $("#order_take_list").html(html)
                });

                layer.open({
                    type: 1,
                    title: '办理记录',
                    shadeClose: true,
                    area: admin.screen() < 2 ? ['80%', '300px'] : ['600px', '500px'],
                    content: `<div id="order_take_list_content">${$('#order_take_list').html()}</div>`
                });

            });

            /**打印**/
            $("body").on("click", "#order_print", async function () {
                if (!order_id) {
                    return layer.msg("请先保存订单！")
                }
                window.open(
                    `/annotation/i/${order_id}/downloads/prints?margin_top=1cm&margin_left=0cm&margin_right=0cm&margin_bottom=1cm`);
            });

            /**表单验证规则**/
            await form.verify({});

            /**置空表单，定位焦点*/
            function order_pros_form_focus() {
                $("#order_pros_form input").each(function () {
                    if ($(this).attr("id") === "GdsSeqno") {
                        $(this).val(annotationItems.total + 1)
                    } else {
                        if (!($(this).is("[no_empty]"))) {
                            $(this).val("")
                        }
                    }
                });
                $("#PutrecSeqno").focus();
            }

            /**加载表体表格*/
            async function transformAnnotationItemsTable(id, data) {
                let data1 = JSON.stringify({AnnotationId: parseInt(id)});
                annotationItems = await admin.post("/annotation_item/datagrid", data1, true);
                /**加载清单产品/报关草稿表格列表**/
                admin.getAnnotationTable(annotationItems, decListData);
                /**如果报关则生成报关商品**/
                // if ($("#DclcusFlag").val() === "1") {
                //  /**如果用户设置报关单序号，检查序号是否合规**/
                //  if (admin.DecListGNoCheck(data, decListData, annotationItems) === false) return;
                //  if (!decListData) {
                // 	 decListData = data.GdsSeqno
                //  }
                // }

                // if (admin.DecListCountCheck(annotationItems.rows, decListData) === false) {
                //  layer.open({
                // 				title: "提示",
                // 				content: "本保税清单对应的报关单表体已经50条(不可超过50条)，请确认后重新录入！",
                // 				icon: 2
                // 			});
                //
                //  return;
                // }

                order_pros_form_focus();
            }

        });
</script>